<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AHRC Championship - Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .modal-backdrop { background-color: rgba(0,0,0,0.5); }
        .modal { transition: opacity 0.3s ease; }
        .admin-btn.active {
            background-color: #2563eb; /* bg-blue-600 */
            color: white;
        }
        .admin-btn {
            background-color: #e5e7eb; /* bg-gray-200 */
            color: #374151; /* text-gray-700 */
        }
    </style>
</head>
<body class="bg-gray-200 text-gray-800">

    <script>
      // Firebase config is placed globally before module scripts
      const firebaseConfig = {
        apiKey: "AIzaSyAYLeTA8morhqnq0p_YC-t5MW6LuE2MzfI",
        authDomain: "ahrc-club-champs.firebaseapp.com",
        projectId: "ahrc-club-champs",
        storageBucket: "ahrc-club-champs.firebasestorage.app",
        messagingSenderId: "275377232283",
        appId: "1:275377232283:web:037a7615609012a61f293e"
      };
    </script>

    <div id="login-view" class="min-h-screen flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-sm">
            <h2 class="text-2xl font-bold text-center mb-6">Admin Login</h2>
            <form id="login-form">
                <div class="mb-4">
                    <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="email" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="password" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition">Log In</button>
            </form>
            <p id="login-error" class="text-red-500 text-sm mt-4 text-center"></p>
        </div>
    </div>

    <div id="admin-view" class="hidden container mx-auto p-4 md:p-8">
        <header class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">Admin Control Panel</h1>
            <button id="logout-button" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition">Log Out</button>
        </header>

        <div class="bg-white p-6 rounded-lg shadow-md">
            <div class="flex items-center mb-4">
                <label for="yearSelectorAdmin" class="text-sm font-medium mr-2">Select Season:</label>
                <select id="yearSelectorAdmin" class="rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></select>
            </div>

            <div class="mb-4 space-y-4">
                <div class="flex flex-wrap items-center gap-2">
                    <span class="text-sm font-medium">Sort by:</span>
                    <div id="sort-buttons-container">
                        <button id="sort-by-time" class="sort-btn admin-btn active text-sm px-3 py-1.5 rounded-md hover:bg-blue-500 hover:text-white transition">Fastest Time</button>
                        <button id="sort-by-date" class="sort-btn admin-btn text-sm px-3 py-1.5 rounded-md hover:bg-blue-500 hover:text-white transition">Newest Parkrun Date</button>
                    </div>
                </div>
                <div class="flex flex-wrap items-center gap-2">
                     <span class="text-sm font-medium">Filter Gender:</span>
                    <div id="filter-buttons-container">
                        <button data-filter-admin="all" class="filter-btn-admin admin-btn active text-sm px-3 py-1.5 rounded-md hover:bg-blue-500 hover:text-white transition">All</button>
                        <button data-filter-admin="male" class="filter-btn-admin admin-btn text-sm px-3 py-1.5 rounded-md hover:bg-blue-500 hover:text-white transition">Male</button>
                        <button data-filter-admin="female" class="filter-btn-admin admin-btn text-sm px-3 py-1.5 rounded-md hover:bg-blue-500 hover:text-white transition">Female</button>
                    </div>
                </div>
                <div class="flex flex-wrap items-center gap-2">
                    <span class="text-sm font-medium">Filter Age:</span>
                    <div id="age-category-filters-admin" class="flex flex-wrap gap-2">
                        </div>
                </div>
            </div>

            <div class="overflow-x-auto">
                <table class="min-w-full bg-white border">
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="py-3 px-4 border-b text-left">Rank</th>
                            <th class="py-3 px-4 border-b text-left">Athlete</th>
                            <th class="py-3 px-4 border-b text-left">Athlete ID</th>
                            <th class="py-3 px-4 border-b text-left">Time</th>
                            <th class="py-3 px-4 border-b text-left">Date</th>
                            <th class="py-3 px-4 border-b text-left">Location</th>
                            <th class="py-3 px-4 border-b text-left">Gender</th>
                            <th class="py-3 px-4 border-b text-left">Age Cat</th>
                            <th class="py-3 px-4 border-b text-left">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="adminResultsBody">
                        </tbody>
                </table>
                 <p id="admin-no-results" class="text-center text-gray-500 py-8 hidden">No entries match the current filters.</p>
            </div>
        </div>
    </div>

    <div id="edit-modal" class="fixed inset-0 z-50 overflow-y-auto hidden modal-backdrop flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl p-8 m-4 max-w-xl w-full">
            <h2 class="text-2xl font-semibold mb-4">Edit Entry</h2>
            <form id="edit-form" class="space-y-4">
                <input type="hidden" id="edit-doc-id">
                <div>
                    <label for="edit-fullName" class="block text-sm font-medium text-gray-700">Full Name</label>
                    <input type="text" id="edit-fullName" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                </div>
                <div>
                    <label for="edit-athleteNumber" class="block text-sm font-medium text-gray-700">Parkrun Athlete Number (Optional)</label>
                    <input type="text" id="edit-athleteNumber" placeholder="e.g., A1234567" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                </div>
                
                <div>
                    <label for="edit-age-category" class="block text-sm font-medium text-gray-700">Age Category</label>
                    <select id="edit-age-category" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                        <option value="Under 17">Under 17</option>
                        <option value="17-29">17-29</option>
                        <option value="30-39">30-39</option>
                        <option value="40-49">40-49</option>
                        <option value="50-59">50-59</option>
                        <option value="60-69">60-69</option>
                        <option value="70+">70+</option>
                    </select>
                </div>

                <div>
                    <label for="edit-gender" class="block text-sm font-medium text-gray-700">Gender</label>
                    <select id="edit-gender" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                    </select>
                </div>
                <div>
                    <label for="edit-parkrunDate" class="block text-sm font-medium text-gray-700">Date of Parkrun</label>
                    <input type="date" id="edit-parkrunDate" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                </div>
                <div>
                    <label for="edit-parkrunTime" class="block text-sm font-medium text-gray-700">Parkrun Time (MM:SS)</label>
                    <input type="text" id="edit-parkrunTime" placeholder="e.g., 21:35" required pattern="\d{1,2}:\d{2}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                </div>
                <div>
                    <label for="edit-location" class="block text-sm font-medium text-gray-700">Parkrun Location</label>
                    <input type="text" id="edit-location" placeholder="e.g., Horsham" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                </div>
                <div class="flex justify-end space-x-4 pt-4">
                    <button type="button" id="cancel-edit" class="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-400">Cancel</button>
                    <button type="submit" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, updateDoc, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // ... Element selections (unchanged) ...
        const loginView = document.getElementById('login-view');
        const adminView = document.getElementById('admin-view');
        const editModal = document.getElementById('edit-modal');
        const loginForm = document.getElementById('login-form');
        const logoutButton = document.getElementById('logout-button');
        const editForm = document.getElementById('edit-form');
        const cancelEditButton = document.getElementById('cancel-edit');
        const yearSelector = document.getElementById('yearSelectorAdmin');
        const resultsBody = document.getElementById('adminResultsBody');
        const noResultsMsg = document.getElementById('admin-no-results');
        const sortButtonsContainer = document.getElementById('sort-buttons-container');
        const filterButtonsContainer = document.getElementById('filter-buttons-container');
        const ageCategoryFiltersAdminContainer = document.getElementById('age-category-filters-admin');
        
        let currentUnsubscribe;
        let selectedYearForEditing;

        let allAthleteDataAdmin = [];
        let activeFilterAdmin = 'all';
        let activeAgeCategoryAdmin = 'all';
        let activeSortAdmin = 'time'; // 'time' or 'date'

        // --- Auth Handling (unchanged) ---
        onAuthStateChanged(auth, user => {
            if (user) {
                loginView.classList.add('hidden');
                adminView.classList.remove('hidden');
                initializeAdminPanel();
            } else {
                adminView.classList.add('hidden');
                loginView.classList.remove('hidden');
                if (currentUnsubscribe) currentUnsubscribe();
                allAthleteDataAdmin = []; // Clear data on logout
            }
        });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const loginError = document.getElementById('login-error');
            try {
                await signInWithEmailAndPassword(auth, email, password);
                loginError.textContent = '';
            } catch (error) {
                loginError.textContent = 'Invalid email or password.';
                console.error("Login failed:", error);
            }
        });

        logoutButton.addEventListener('click', () => signOut(auth));

        // --- Admin Panel Logic (unchanged) ---
        const getChampionshipYearString = (date) => {
            const year = date.getFullYear();
            const month = date.getMonth();
            return month >= 10 ? `${year}-${year + 1}` : `${year - 1}-${year}`;
        };
        const timeToSeconds = (timeStr) => {
            if (!timeStr || !timeStr.includes(':')) return 0;
            const [minutes, seconds] = timeStr.split(':').map(Number);
            return (minutes * 60) + (seconds || 0);
        };

        function listenToYearData(yearString) {
            if (currentUnsubscribe) currentUnsubscribe();
            selectedYearForEditing = yearString;
            activeFilterAdmin = 'all';
            activeAgeCategoryAdmin = 'all';
            activeSortAdmin = 'time';

            const athletesCollectionRef = collection(db, `championships/${yearString}/athletes`);
            currentUnsubscribe = onSnapshot(athletesCollectionRef, (snapshot) => {
                allAthleteDataAdmin = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                applyAdminFilters();
            });
        }

        function applyAdminFilters() {
            let filteredData = allAthleteDataAdmin;

            if (activeFilterAdmin !== 'all') {
                filteredData = filteredData.filter(a => a.gender.toLowerCase() === activeFilterAdmin);
            }
            
            if (activeAgeCategoryAdmin !== 'all') {
                filteredData = filteredData.filter(a => a.age_category === activeAgeCategoryAdmin);
            }

            if (activeSortAdmin === 'time') {
                filteredData.sort((a, b) => a.time_seconds - b.time_seconds);
            } else if (activeSortAdmin === 'date') {
                filteredData.sort((a, b) => new Date(b.date_of_time) - new Date(a.date_of_time));
            }

            renderAdminTable(filteredData);
            updateAdminFilterButtons();
            updateAdminAgeCategoryButtons();
        }
        
        // #################################################
        // ## MODIFICATION 2: Updated renderAdminTable function ##
        // #################################################
        function renderAdminTable(athletes) {
            resultsBody.innerHTML = '';
            noResultsMsg.classList.toggle('hidden', athletes.length > 0);
            
            let currentRank = 0;
            let lastTimeSeconds = -1;

            athletes.forEach((athlete, index) => {
                const row = document.createElement('tr');
                
                let rankToShow;
                // Only apply tie logic if sorting by time
                if (activeSortAdmin === 'time') {
                    if (athlete.time_seconds !== lastTimeSeconds) {
                        currentRank = index + 1;
                        lastTimeSeconds = athlete.time_seconds;
                        rankToShow = currentRank;
                    } else {
                        rankToShow = currentRank; // It's a tie
                    }
                } else {
                    rankToShow = index + 1; // Just show row number if sorting by date
                }

                row.innerHTML = `
                    <td class="py-3 px-4 border-b font-bold">${rankToShow}</td>
                    <td class="py-3 px-4 border-b">${athlete.name}</td>
                    <td class="py-3 px-4 border-b">${athlete.athlete_number || 'N/A'}</td>
                    <td class="py-3 px-4 border-b font-semibold">${athlete.fastest_time}</td>
                    <td class="py-3 px-4 border-b">${new Date(athlete.date_of_time).toLocaleDateString()}</td>
                    <td class="py-3 px-4 border-b">${athlete.location || 'N/A'}</td>
                    <td class="py-3 px-4 border-b">${athlete.gender}</td>
                    <td class="py-3 px-4 border-b">${athlete.age_category}</td>
                    <td class="py-3 px-4 border-b space-x-2">
                        <button data-id="${athlete.id}" class="edit-btn bg-yellow-500 text-white text-sm font-bold py-1 px-3 rounded hover:bg-yellow-600">Edit</button>
                        <button data-id="${athlete.id}" data-name="${athlete.name}" class="delete-btn bg-red-500 text-white text-sm font-bold py-1 px-3 rounded hover:bg-red-600">Delete</button>
                    </td>
                `;
                resultsBody.appendChild(row);
            });
        }
        
        // ... Other functions (updateAdminFilterButtons, updateAdminAgeCategoryButtons, table actions, modal logic) (unchanged) ...
        function updateAdminFilterButtons() {
            sortButtonsContainer.querySelectorAll('.sort-btn').forEach(btn => {
                btn.classList.toggle('active', btn.id === `sort-by-${activeSortAdmin}`);
            });
            filterButtonsContainer.querySelectorAll('.filter-btn-admin').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filterAdmin === activeFilterAdmin);
            });
        }

        function updateAdminAgeCategoryButtons() {
            ageCategoryFiltersAdminContainer.innerHTML = '';
            
            const categories = [...new Set(allAthleteDataAdmin.map(a => a.age_category))].sort();

            const createButton = (text, category) => {
                const btn = document.createElement('button');
                btn.textContent = text;
                btn.dataset.ageCategory = category;
                btn.className = `age-filter-btn-admin admin-btn text-sm px-3 py-1.5 rounded-md hover:bg-blue-500 hover:text-white transition ${activeAgeCategoryAdmin === category ? 'active' : ''}`;
                return btn;
            };

            ageCategoryFiltersAdminContainer.appendChild(createButton('All Ages', 'all'));
            
            categories.forEach(cat => {
                if(cat) { 
                    ageCategoryFiltersAdminContainer.appendChild(createButton(cat, cat));
                }
            });
        }

        resultsBody.addEventListener('click', async (e) => {
            const docId = e.target.dataset.id;
            if (!docId) return;

            if (e.target.classList.contains('delete-btn')) {
                const athleteName = e.target.dataset.name;
                if (confirm(`Are you sure you want to delete the entry for ${athleteName}?`)) {
                    try {
                        await deleteDoc(doc(db, `championships/${selectedYearForEditing}/athletes`, docId));
                    } catch (error) {
                        console.error("Delete failed:", error);
                        alert("Could not delete entry.");
                    }
                }
            }

            if (e.target.classList.contains('edit-btn')) {
                const athleteData = allAthleteDataAdmin.find(a => a.id === docId);
                if (athleteData) {
                     openEditModal(athleteData, docId);
                }
            }
        });

        function openEditModal(data, docId) {
            document.getElementById('edit-doc-id').value = docId;
            document.getElementById('edit-fullName').value = data.name;
            document.getElementById('edit-athleteNumber').value = data.athlete_number || '';
            document.getElementById('edit-age-category').value = data.age_category; 
            document.getElementById('edit-gender').value = data.gender;
            document.getElementById('edit-parkrunDate').value = data.date_of_time;
            document.getElementById('edit-parkrunTime').value = data.fastest_time;
            document.getElementById('edit-location').value = data.location || '';
            editModal.classList.remove('hidden');
        }

        cancelEditButton.addEventListener('click', () => editModal.classList.add('hidden'));

        editForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const docId = document.getElementById('edit-doc-id').value;
            const parkrunDate = document.getElementById('edit-parkrunDate').value;
            const parkrunTime = document.getElementById('edit-parkrunTime').value;

            const updatedData = {
                name: document.getElementById('edit-fullName').value,
                athlete_number: document.getElementById('edit-athleteNumber').value.trim(),
                gender: document.getElementById('edit-gender').value,
                date_of_time: parkrunDate,
                fastest_time: parkrunTime,
                time_seconds: timeToSeconds(parkrunTime),
                age_category: document.getElementById('edit-age-category').value, 
                location: document.getElementById('edit-location').value.trim()
            };
            
            try {
                const docRef = doc(db, `championships/${selectedYearForEditing}/athletes`, docId);
                await updateDoc(docRef, updatedData);
                editModal.classList.add('hidden');
            } catch(error) {
                console.error("Update failed:", error);
                alert("Could not save changes.");
            }
        });

        // --- Initialization (unchanged) ---
        function initializeAdminPanel() {
            const metadataRef = doc(db, "championships", "_metadata");
            onSnapshot(metadataRef, (docSnap) => {
                const currentSeason = getChampionshipYearString(new Date());
                let years = [];
                if (docSnap.exists()) years = docSnap.data().availableYears || [];
                if (!years.includes(currentSeason)) years.push(currentSeason);
                years.sort().reverse();
                
                const currentSelectedYear = yearSelector.value;
                yearSelector.innerHTML = '';
                years.forEach(yearString => {
                    const option = document.createElement('option');
                    option.value = yearString;
                    option.textContent = yearString.replace('-', '/');
                    yearSelector.appendChild(option);
                });

                const initialYear = years.includes(currentSelectedYear) ? currentSelectedYear : (yearSelector.axlue || currentSeason);
                yearSelector.value = initialYear;
                listenToYearData(initialYear);
            });

            yearSelector.addEventListener('change', () => listenToYearData(yearSelector.value));

            sortButtonsContainer.addEventListener('click', (e) => {
                const sortBtn = e.target.closest('.sort-btn');
                if (!sortBtn) return;
                activeSortAdmin = sortBtn.id === 'sort-by-time' ? 'time' : 'date';
                applyAdminFilters();
            });
            
            filterButtonsContainer.addEventListener('click', (e) => {
                const filterBtn = e.target.closest('.filter-btn-admin');
                if (!filterBtn) return;
                activeFilterAdmin = filterBtn.dataset.filterAdmin;
                applyAdminFilters();
            });

            ageCategoryFiltersAdminContainer.addEventListener('click', (e) => {
                const ageBtn = e.target.closest('.age-filter-btn-admin');
                if (!ageBtn) return;
                activeAgeCategoryAdmin = ageBtn.dataset.ageCategory;
                applyAdminFilters();
            });
        }
        
    </script>
</body>
</html>
