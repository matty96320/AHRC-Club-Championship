<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AHRC Self-Reporting Championship</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .table-responsive { display: block; width: 100%; overflow-x: auto; }
        .feedback { padding: 1rem; margin-top: 1rem; border-radius: 0.5rem; text-align: center; font-weight: 500; display: none; }
        .feedback.success { background-color: #d1fae5; color: #065f46; }
        .feedback.error { background-color: #fee2e2; color: #991b1b; }
        .feedback.info { background-color: #dbeafe; color: #1e40af; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- 
      PASTE YOUR FIREBASE CONFIGURATION HERE 
      This is the only manual step. Replace the placeholder object below
      with the firebaseConfig object from your Firebase project settings.
    -->
    <script>
const firebaseConfig = {
  apiKey: "AIzaSyAYLeTA8morhqnq0p_YC-t5MW6LuE2MzfI",
  authDomain: "ahrc-club-champs.firebaseapp.com",
  projectId: "ahrc-club-champs",
  storageBucket: "ahrc-club-champs.firebasestorage.app",
  messagingSenderId: "275377232283",
  appId: "1:275377232283:web:037a7615609012a61f293e"
};
    </script>

    <div class="container mx-auto p-4 md:p-8">
        <header class="bg-white shadow-md rounded-lg p-6 mb-8 text-center">
            
            <h1 class="text-3xl font-bold text-blue-800">Ashington Hurst Running Club</h1>
            <p class="text-xl text-gray-600">Self-Reporting Parkrun Championship</p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Submission Form Section -->
            <div class="lg:col-span-1 bg-white shadow-md rounded-lg p-6 h-fit">
                <h2 class="text-2xl font-semibold mb-4 border-b pb-2">Submit Your Time</h2>
                <form id="timeSubmissionForm" class="space-y-4">
                    <div>
                        <label for="fullName" class="block text-sm font-medium text-gray-700">Full Name</label>
                        <input type="text" id="fullName" name="fullName" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="dob" class="block text-sm font-medium text-gray-700">Date of Birth</label>
                        <input type="date" id="dob" name="dob" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="gender" class="block text-sm font-medium text-gray-700">Gender</label>
                        <select id="gender" name="gender" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                        </select>
                    </div>
                    <div>
                        <label for="parkrunDate" class="block text-sm font-medium text-gray-700">Date of Parkrun</label>
                        <input type="date" id="parkrunDate" name="parkrunDate" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="parkrunTime" class="block text-sm font-medium text-gray-700">Parkrun Time (MM:SS)</label>
                        <input type="text" id="parkrunTime" name="parkrunTime" placeholder="e.g., 21:35" required pattern="\d{1,2}:\d{2}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-300 shadow-md">Submit Time</button>
                </form>
                <div id="feedbackMessage" class="feedback"></div>
            </div>

            <!-- Results Section -->
            <div class="lg:col-span-2 bg-white shadow-md rounded-lg p-6">
                <div class="flex flex-wrap justify-between items-center mb-4">
                     <h2 id="championshipHeader" class="text-2xl font-semibold">Championship Standings</h2>
                     <div>
                        <label for="yearSelector" class="text-sm font-medium mr-2">Season:</label>
                        <select id="yearSelector" class="rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></select>
                     </div>
                </div>
               
                <div id="loading" class="text-center py-8">
                    <p class="text-gray-600">Loading championship data...</p>
                </div>

                <div id="resultsContent" class="hidden">
                    <div class="flex flex-wrap gap-2 mb-4">
                        <button data-filter="all" class="filter-btn bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 transition">All</button>
                        <button data-filter="male" class="filter-btn bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300 transition">Male</button>
                        <button data-filter="female" class="filter-btn bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300 transition">Female</button>
                    </div>
                    <div id="age-category-filters" class="flex flex-wrap gap-2 mb-4 hidden"></div>
                    <button id="exportCsv" class="mb-4 bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition duration-300 shadow-md">Export to CSV</button>

                    <div class="table-responsive">
                        <table class="min-w-full bg-white border">
                            <thead class="bg-gray-200">
                                <tr>
                                    <th class="py-3 px-4 border-b text-left">Rank</th>
                                    <th class="py-3 px-4 border-b text-left">Athlete</th>
                                    <th class="py-3 px-4 border-b text-left">Fastest Time</th>
                                    <th class="py-3 px-4 border-b text-left">Date</th>
                                    <th class="py-3 px-4 border-b text-left">Gender</th>
                                    <th class="py-3 px-4 border-b text-left">Age Category</th>
                                </tr>
                            </thead>
                            <tbody id="resultsBody"></tbody>
                        </table>
                    </div>
                    <p id="no-results" class="text-center text-gray-500 py-8 hidden">No results match the current filters.</p>
                </div>
            </div>
        </main>
        
        <footer class="text-center mt-8 text-sm text-gray-500">
            <p>&copy; 2025 Ashington Hurst Running Club Championship Tracker</p>
        </footer>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, setDoc, onSnapshot, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const form = document.getElementById('timeSubmissionForm');
        const feedbackMessage = document.getElementById('feedbackMessage');
        const loadingDiv = document.getElementById('loading');
        const resultsContent = document.getElementById('resultsContent');
        const resultsBody = document.getElementById('resultsBody');
        const exportCsvButton = document.getElementById('exportCsv');
        const filterButtons = document.querySelectorAll('.filter-btn');
        const ageCategoryFiltersContainer = document.getElementById('age-category-filters');
        const noResultsMessage = document.getElementById('no-results');
        const yearSelector = document.getElementById('yearSelector');
        const championshipHeader = document.getElementById('championshipHeader');

        let allAthleteData = [];
        let displayedData = [];
        let activeFilter = 'all';
        let activeAgeCategory = 'all';
        let selectedYear = '';
        let unsubscribe;

        const getChampionshipYearString = (date) => {
            const year = date.getFullYear();
            const month = date.getMonth(); // 0-indexed, Nov is 10
            if (month >= 10) return `${year}-${year + 1}`;
            return `${year - 1}-${year}`;
        };

        const timeToSeconds = (timeStr) => {
            const [minutes, seconds] = timeStr.split(':').map(Number);
            return (minutes * 60) + seconds;
        };

        const calculateAgeCategory = (dobString, parkrunDateString) => {
            const dob = new Date(dobString);
            const parkrunDate = new Date(parkrunDateString);
            let age = parkrunDate.getFullYear() - dob.getFullYear();
            const m = parkrunDate.getMonth() - dob.getMonth();
            if (m < 0 || (m === 0 && parkrunDate.getDate() < dob.getDate())) age--;
            if (age < 18) return 'Under 18';
            if (age >= 18 && age < 30) return '18-29';
            if (age >= 30 && age < 40) return '30-39';
            if (age >= 40 && age < 50) return '40-49';
            if (age >= 50 && age < 60) return '50-59';
            if (age >= 60 && age < 70) return '60-69';
            return '70+';
        };

        const showFeedback = (message, type, duration = 4000) => {
            feedbackMessage.textContent = message;
            feedbackMessage.className = `feedback ${type}`;
            feedbackMessage.style.display = 'block';
            setTimeout(() => { feedbackMessage.style.display = 'none'; }, duration);
        };

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(form);
            const parkrunDate = new Date(formData.get('parkrunDate'));
            const submissionYear = getChampionshipYearString(parkrunDate);

            const fullName = formData.get('fullName').trim();
            const docId = fullName.toLowerCase().replace(/\s+/g, '-');
            const newTimeSeconds = timeToSeconds(formData.get('parkrunTime'));
            
            const athletesCollectionRef = collection(db, `championships/${submissionYear}/athletes`);
            const athleteDocRef = doc(athletesCollectionRef, docId);

            try {
                const docSnap = await getDoc(athleteDocRef);
                if (docSnap.exists() && newTimeSeconds >= docSnap.data().time_seconds) {
                    showFeedback('This is not faster than your current best for this season.', 'info');
                    return;
                }
                const dataToSave = { name: fullName, dob: formData.get('dob'), gender: formData.get('gender'), fastest_time: formData.get('parkrunTime'), time_seconds: newTimeSeconds, date_of_time: formData.get('parkrunDate'), age_category: calculateAgeCategory(formData.get('dob'), formData.get('parkrunDate')) };
                await setDoc(athleteDocRef, dataToSave);

                // --- NEW: Update the metadata document to ensure this year is listed ---
                const metadataRef = doc(db, "championships", "_metadata");
                await setDoc(metadataRef, { availableYears: arrayUnion(submissionYear) }, { merge: true });

                showFeedback(`Success! Time saved for ${submissionYear.replace('-', '/')} season.`, 'success');
                form.reset();
            } catch (error) {
                console.error("Error writing document: ", error);
                showFeedback('Could not save your time. Please try again.', 'error');
            }
        });

        const applyFilters = () => {
            let filteredData = allAthleteData;
            if (activeFilter !== 'all') filteredData = filteredData.filter(a => a.gender.toLowerCase() === activeFilter);
            if (activeAgeCategory !== 'all') filteredData = filteredData.filter(a => a.age_category === activeAgeCategory);
            filteredData.sort((a, b) => a.time_seconds - b.time_seconds);
            displayedData = filteredData;
            renderTable();
            updateAgeCategoryButtons();
        };

        const renderTable = () => {
            resultsBody.innerHTML = '';
            noResultsMessage.classList.toggle('hidden', displayedData.length > 0);
            if (displayedData.length > 0) {
                displayedData.forEach((athlete, index) => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50';
                    row.innerHTML = `
                        <td class="py-3 px-4 border-b font-bold">${index + 1}</td>
                        <td class="py-3 px-4 border-b font-medium">${athlete.name}</td>
                        <td class="py-3 px-4 border-b font-semibold text-blue-700">${athlete.fastest_time}</td>
                        <td class="py-3 px-4 border-b">${new Date(athlete.date_of_time).toLocaleDateString()}</td>
                        <td class="py-3 px-4 border-b">${athlete.gender}</td>
                        <td class="py-3 px-4 border-b">${athlete.age_category}</td>
                    `;
                    resultsBody.appendChild(row);
                });
            }
        };
        
        const updateAgeCategoryButtons = () => {
            ageCategoryFiltersContainer.innerHTML = '';
            if (activeFilter === 'all') {
                ageCategoryFiltersContainer.classList.add('hidden');
                return;
            }
            ageCategoryFiltersContainer.classList.remove('hidden');
            const categories = [...new Set(allAthleteData.filter(a => a.gender.toLowerCase() === activeFilter).map(a => a.age_category))].sort();
            const createButton = (text, category) => {
                const btn = document.createElement('button');
                btn.textContent = text;
                btn.dataset.ageCategory = category;
                btn.className = `age-filter-btn px-3 py-1.5 rounded-md text-sm transition ${activeAgeCategory === category ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`;
                return btn;
            };
            ageCategoryFiltersContainer.appendChild(createButton(`All ${activeFilter === 'male' ? 'Men' : 'Women'}`, 'all'));
            categories.forEach(cat => ageCategoryFiltersContainer.appendChild(createButton(cat, cat)));
        };

        filterButtons.forEach(button => {
            button.addEventListener('click', () => {
                filterButtons.forEach(btn => { btn.classList.replace('bg-blue-500', 'bg-gray-200'); btn.classList.replace('text-white', 'text-gray-700'); });
                button.classList.replace('bg-gray-200', 'bg-blue-500'); button.classList.add('text-white');
                activeFilter = button.dataset.filter; activeAgeCategory = 'all'; applyFilters();
            });
        });

        ageCategoryFiltersContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('age-filter-btn')) { activeAgeCategory = e.target.dataset.ageCategory; applyFilters(); }
        });
        
        exportCsvButton.addEventListener('click', () => {
            if (displayedData.length === 0) { showFeedback('No data to export.', 'info', 2000); return; }
            const headers = ['Rank', 'Athlete', 'Fastest Time', 'Date', 'Gender', 'Age Category'];
            const csvRows = [headers.join(',')];
            displayedData.forEach((athlete, index) => {
                csvRows.push([index + 1, `"${athlete.name}"`, athlete.fastest_time, athlete.date_of_time, athlete.gender, athlete.age_category].join(','));
            });
            const blob = new Blob([csvRows.join('\n')], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `championship_results_${selectedYear.replace('-', '_')}.csv`;
            link.click();
            URL.revokeObjectURL(link.href);
        });

        function listenToYearData(yearString) {
            if (unsubscribe) unsubscribe();
            selectedYear = yearString;
            championshipHeader.textContent = `Standings for ${yearString.replace('-', '/')}`;
            loadingDiv.style.display = 'block';
            resultsContent.classList.add('hidden');
            allAthleteData = [];
            applyFilters();

            const athletesCollectionRef = collection(db, `championships/${yearString}/athletes`);
            unsubscribe = onSnapshot(athletesCollectionRef, (snapshot) => {
                allAthleteData = snapshot.docs.map(doc => doc.data());
                loadingDiv.style.display = 'none';
                resultsContent.classList.remove('hidden');
                applyFilters();
            }, (error) => {
                console.error(`Error for ${yearString}: `, error);
                loadingDiv.textContent = "Error loading data. Try another season.";
                noResultsMessage.classList.remove('hidden');
                noResultsMessage.textContent = `No data found for the ${yearString.replace('-', '/')} season.`;
            });
        }

        async function initialize() {
            try {
                await signInAnonymously(auth);

                // --- NEW: Fetch the list of available years from the metadata document ---
                const metadataRef = doc(db, "championships", "_metadata");
                onSnapshot(metadataRef, (docSnap) => {
                    const currentSeason = getChampionshipYearString(new Date());
                    let years = [];

                    if (docSnap.exists()) {
                        years = docSnap.data().availableYears || [];
                    }
                    
                    // Ensure the current season is always an option, even if it has no data yet
                    if (!years.includes(currentSeason)) {
                        years.push(currentSeason);
                    }
                    
                    years.sort().reverse(); // Show most recent years first

                    // Populate the dropdown
                    yearSelector.innerHTML = '';
                    years.forEach(yearString => {
                        const option = document.createElement('option');
                        option.value = yearString;
                        option.textContent = yearString.replace('-', '/');
                        yearSelector.appendChild(option);
                    });

                    // Set the initial view to the current season
                    yearSelector.value = currentSeason;
                    if (selectedYear !== currentSeason) {
                         listenToYearData(currentSeason);
                    }
                });
                
                yearSelector.addEventListener('change', () => listenToYearData(yearSelector.value));

            } catch(error) {
                console.error("Initialization failed:", error);
                loadingDiv.textContent = "Could not connect to the server. Please refresh.";
            }
        }

        initialize();
    </script>
</body>
</html>