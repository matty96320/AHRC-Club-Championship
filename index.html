<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AHRC Parkrun Club Championship</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .table-responsive { display: block; width: 100%; overflow-x: auto; }
        .feedback { padding: 1rem; margin-top: 1rem; border-radius: 0.5rem; text-align: center; font-weight: 500; display: none; }
        .feedback.success { background-color: #d1fae5; color: #065f46; }
        .feedback.error { background-color: #fee2e2; color: #991b1b; }
        .feedback.info { background-color: #dbeafe; color: #1e40af; }
        /* Custom colors for AHRC */
        .bg-ahrc-yellow { background-color: #FDD023; }
        .text-ahrc-purple { color: #5C2D91; }
        .border-ahrc-yellow { border-color: #FDD023; }
        .bg-ahrc-purple { background-color: #5C2D91; }
        .hover\:bg-ahrc-purple-darker:hover { background-color: #4A247A; } /* Slightly darker purple for hover */
        .focus\:border-ahrc-yellow:focus { border-color: #FDD023; }
        .focus\:ring-ahrc-yellow:focus { ring-color: #FDD023; }
        .text-ahrc-yellow { color: #FDD023; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

<div class="container mx-auto p-4 md:p-8">
    <header class="bg-white shadow-md rounded-lg p-6 mb-8 text-center">
        
        <img src="https://matty96320.github.io/AHRC-Club-Championship/IMG_0070.jpeg"alt="Ashington Hirst Running Club Logo" class="mx-auto h-24 mb-4">
        
        <h1 class="text-3xl font-bold text-ahrc-purple">Ashington Hirst Running Club</h1>
        <p class="text-xl text-gray-600">Parkrun Club Championship</p>
    </header>

    <main class="space-y-8">
        
        <div class="bg-white shadow-md rounded-lg overflow-hidden">
            <nav class="flex border-b border-gray-200">
                <button id="tab-form-btn" data-tab="form" class="tab-btn-nav px-6 py-3 font-semibold text-ahrc-purple border-b-2 border-ahrc-purple">
                    Submit Your Time
                </button>
                <button id="tab-results-btn" data-tab="results" class="tab-btn-nav px-6 py-3 font-semibold text-gray-500 hover:text-gray-700">
                    Championship Standings
                </button>
            </nav>
        </div>

        <div id="tab-pane-form" class="tab-pane bg-white shadow-md rounded-lg p-6 h-fit">
            <h2 class="text-2xl font-semibold mb-4 border-b pb-2">Submit Your Time</h2>
            <form id="timeSubmissionForm" class="space-y-4">
                <div>
                    <label for="fullName" class="block text-sm font-medium text-gray-700">Full Name</label>
                    <input type="text" id="fullName" name="fullName" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-ahrc-yellow focus:ring-ahrc-yellow">
                </div>
                <div>
                    <label for="athleteNumber" class="block text-sm font-medium text-gray-700">Parkrun Athlete Number (Optional)</label>
                    <input type="text" id="athleteNumber" name="athleteNumber" placeholder="e.g., A1234567" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-ahrc-yellow focus:ring-ahrc-yellow">
                </div>
                
                <div>
                    <label for="gender" class="block text-sm font-medium text-gray-700">Gender</label>
                    <select id="gender" name="gender" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-ahrc-yellow focus:ring-ahrc-yellow">
                        <option value="">Select gender...</option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                    </select>
                </div>

                <div>
                    <label for="ageCategory" class="block text-sm font-medium text-gray-700">Age Category (on date of parkrun)</label>
                    <select id="ageCategory" name="ageCategory" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-ahrc-yellow focus:ring-ahrc-yellow">
                        <option value="">Select your age category...</option>
                        <option value="Under 17">Under 17</option>
                        <option value="17-29">17-29</option>
                        <option value="30-39">30-39</option>
                        <option value="40-49">40-49</option>
                        <option value="50-59">50-59</option>
                        <option value="60-69">60-69</option>
                        <option value="70+">70+</option>
                    </select>
                </div>

                <div>
                    <label for="parkrunDate" class="block text-sm font-medium text-gray-700">Date of Parkrun</label>
                    <input type="date" id="parkrunDate" name="parkrunDate" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-ahrc-yellow focus:ring-ahrc-yellow">
                </div>
                <div>
                    <label for="parkrunTime" class="block text-sm font-medium text-gray-700">Parkrun Time (MM:SS)</label>
                    <input type="text" id="parkrunTime" name="parkrunTime" placeholder="e.g., 21:35" required pattern="\d{1,2}:\d{2}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-ahrc-yellow focus:ring-ahrc-yellow">
                </div>
                <div>
                    <label for="parkrunLocation" class="block text-sm font-medium text-gray-700">Parkrun Location</label>
                    <input type="text" id="parkrunLocation" name="parkrunLocation" placeholder="e.g., Horsham, Worthing" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-ahrc-yellow focus:ring-ahrc-yellow">
                </div>
                <button type="submit" class="w-full bg-ahrc-purple text-white font-bold py-2 px-4 rounded-lg hover:bg-ahrc-purple-darker transition duration-300 shadow-md disabled:bg-gray-400" disabled>Connecting...</button>
            </form>
            <div id="feedbackMessage" class="feedback"></div>
        </div>

        <div id="tab-pane-results" class="tab-pane bg-white shadow-md rounded-lg p-6 hidden">
            <div class="flex flex-wrap justify-between items-center mb-4">
                 <h2 id="championshipHeader" class="text-2xl font-semibold">Championship Standings</h2>
                 <div>
                    <label for="yearSelector" class="text-sm font-medium mr-2">Season:</label>
                    <select id="yearSelector" class="rounded-md border-gray-300 shadow-sm focus:border-ahrc-yellow focus:ring-ahrc-yellow"></select>
                 </div>
            </div>
           
            <div id="loading" class="text-center py-8">
                <p class="text-gray-600">Loading championship data...</p>
            </div>

            <div id="resultsContent" class="hidden">
                <div class="bg-gray-50 rounded-lg p-4 mb-4 border border-gray-200">
                    <div class="flex flex-wrap items-center gap-4">
                        <div class="flex-1 min-w-[200px]">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Gender</label>
                            <div class="flex gap-2">
                                <button data-filter="all" class="filter-btn bg-ahrc-purple text-white px-4 py-2 rounded-md hover:bg-ahrc-purple-darker transition flex-1">All Athletes</button>
                                <button data-filter="male" class="filter-btn bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300 transition flex-1">Men</button>
                                <button data-filter="female" class="filter-btn bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300 transition flex-1">Women</button>
                            </div>
                        </div>
                        <div class="flex-1 min-w-[200px]">
                            <label for="ageCategorySelect" class="block text-sm font-medium text-gray-700 mb-2">Age Category</label>
                            <select id="ageCategorySelect" class="w-full rounded-md border-gray-300 shadow-sm focus:border-ahrc-yellow focus:ring-ahrc-yellow px-4 py-2">
                                <option value="all">All Ages</option>
                            </select>
                        </div>
                        <div class="flex items-end gap-2">
                            <button id="resetFilters" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 transition font-medium">
                                Reset Filters
                            </button>
                        </div>
                    </div>
                    <div id="filterSummary" class="mt-3 text-sm text-gray-600 hidden">
                        <span class="font-medium">Showing:</span> <span id="filterSummaryText"></span>
                    </div>
                </div>
                <button id="exportCsv" class="mb-4 bg-ahrc-yellow text-ahrc-purple font-bold py-2 px-4 rounded-lg hover:bg-yellow-400 transition duration-300 shadow-md">Export to CSV</button>

                <div class="table-responsive">
                    <table class="min-w-full bg-white border">
                        <thead class="bg-gray-200">
                            <tr>
                                <th class="py-3 px-4 border-b text-left">Rank</th>
                                <th class="py-3 px-4 border-b text-left">Athlete</th>
                                <th class="py-3 px-4 border-b text-left">Fastest Time</th>
                                <th class="py-3 px-4 border-b text-left">Date</th>
                                <th class="py-3 px-4 border-b text-left">Location</th>
                                <th class="py-3 px-4 border-b text-left">Gender</th>
                                <th class="py-3 px-4 border-b text-left">Age Category</th>
                            </tr>
                        </thead>
                        <tbody id="resultsBody"></tbody>
                    </table>
                </div>
                <p id="no-results" class="text-center text-gray-500 py-8 hidden">No results match the current filters.</p>
            </div>
        </div>
    </main>
    
    <footer class="text-center mt-8 text-sm text-gray-500">
        <p>&copy; 2025 Ashington Hurst Running Club Championship Tracker</p>
    </footer>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, doc, getDoc, setDoc, onSnapshot, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const manualFirebaseConfig = {
      apiKey: "AIzaSyAYLeTA8morhqnq0p_YC-t5MW6LuE2MzfI",
      authDomain: "ahrc-club-champs.firebaseapp.com",
      projectId: "ahrc-club-champs",
      storageBucket: "ahrc-club-champs.firebasestorage.app",
      messagingSenderId: "275377232283",
      appId: "1:275377232283:web:037a7615609012a61f293e"
    };

    const app = initializeApp(manualFirebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ... Element selections (unchanged) ...
    const form = document.getElementById('timeSubmissionForm');
    const submitButton = form.querySelector('button[type="submit"]'); 
    const feedbackMessage = document.getElementById('feedbackMessage');
    
    const tabFormBtn = document.getElementById('tab-form-btn');
    const tabResultsBtn = document.getElementById('tab-results-btn');
    const tabFormPane = document.getElementById('tab-pane-form');
    const tabResultsPane = document.getElementById('tab-pane-results');

    const loadingDiv = document.getElementById('loading');
    const resultsContent = document.getElementById('resultsContent');
    const resultsBody = document.getElementById('resultsBody');
    const exportCsvButton = document.getElementById('exportCsv');
    const filterButtons = document.querySelectorAll('.filter-btn');
    const ageCategorySelect = document.getElementById('ageCategorySelect');
    const resetFiltersBtn = document.getElementById('resetFilters');
    const filterSummary = document.getElementById('filterSummary');
    const filterSummaryText = document.getElementById('filterSummaryText');
    const noResultsMessage = document.getElementById('no-results');
    const yearSelector = document.getElementById('yearSelector');
    const championshipHeader = document.getElementById('championshipHeader');

    const tabButtons = [tabFormBtn, tabResultsBtn];
    const tabPanes = [tabFormPane, tabResultsPane];


    // ... Helper functions (setActiveTab, getChampionshipYearString, timeToSeconds, showFeedback) (unchanged) ...
    const setActiveTab = (tabName) => {
        tabButtons.forEach(btn => {
            if (btn.dataset.tab === tabName) {
                btn.classList.add('text-ahrc-purple', 'border-b-2', 'border-ahrc-purple');
                btn.classList.remove('text-gray-500', 'hover:text-gray-700');
            } else {
                btn.classList.remove('text-ahrc-purple', 'border-b-2', 'border-ahrc-purple');
                btn.classList.add('text-gray-500', 'hover:text-gray-700');
            }
        });

        tabPanes.forEach(pane => {
            if (pane.id === `tab-pane-${tabName}`) {
                pane.classList.remove('hidden');
            } else {
                pane.classList.add('hidden');
            }
        });
    };

    tabFormBtn.addEventListener('click', () => setActiveTab('form'));
    tabResultsBtn.addEventListener('click', () => setActiveTab('results'));

    let allAthleteData = [];
    let displayedData = [];
    let activeFilter = 'all';
    let activeAgeCategory = 'all';
    let selectedYear = '';
    let unsubscribe;

    const getChampionshipYearString = (date) => {
        const year = date.getFullYear();
        const month = date.getMonth();
        if (month >= 10) return `${year}-${year + 1}`;
        return `${year - 1}-${year}`;
    };

    const timeToSeconds = (timeStr) => {
        const [minutes, seconds] = timeStr.split(':').map(Number);
        return (minutes * 60) + seconds;
    };

    const showFeedback = (message, type, duration = 4000) => {
        feedbackMessage.textContent = message;
        feedbackMessage.className = `feedback ${type}`;
        feedbackMessage.style.display = 'block';
        setTimeout(() => { feedbackMessage.style.display = 'none'; }, duration);
    };


    // ... Form submission logic (unchanged) ...
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(form);
        const parkrunDate = new Date(formData.get('parkrunDate'));
        const submissionYear = getChampionshipYearString(parkrunDate);

        const fullName = formData.get('fullName').trim();
        const docId = fullName.toLowerCase().replace(/\s+/g, '-');
        const newTimeSeconds = timeToSeconds(formData.get('parkrunTime'));
        
        const athletesCollectionRef = collection(db, `championships/${submissionYear}/athletes`);
        const athleteDocRef = doc(athletesCollectionRef, docId);

        try {
            const docSnap = await getDoc(athleteDocRef);
            if (docSnap.exists() && newTimeSeconds >= docSnap.data().time_seconds) {
                showFeedback('This is not faster than your current best for this season.', 'info');
                return;
            }
            
            const dataToSave = {
                name: fullName,
                athlete_number: formData.get('athleteNumber').trim(),
                gender: formData.get('gender'),
                fastest_time: formData.get('parkrunTime'),
                time_seconds: newTimeSeconds,
                date_of_time: formData.get('parkrunDate'),
                age_category: formData.get('ageCategory'), 
                location: formData.get('parkrunLocation').trim()
            };
            await setDoc(athleteDocRef, dataToSave);

            const metadataRef = doc(db, "championships", "_metadata");
            await setDoc(metadataRef, { availableYears: arrayUnion(submissionYear) }, { merge: true });

            showFeedback(`Success! Time saved for ${submissionYear.replace('-', '/')} season.`, 'success');
            form.reset();
        } catch (error) {
            console.error("Error writing document: ", error);
            showFeedback('Could not save your time. Please try again.', 'error');
        }
    });

    // ... Filter logic (applyFilters, updateFilterSummary) (unchanged) ...
    const applyFilters = () => {
        let filteredData = allAthleteData;
        if (activeFilter !== 'all') filteredData = filteredData.filter(a => a.gender.toLowerCase() === activeFilter);
        if (activeAgeCategory !== 'all') filteredData = filteredData.filter(a => a.age_category === activeAgeCategory);
        filteredData.sort((a, b) => a.time_seconds - b.time_seconds);
        displayedData = filteredData;
        renderTable();
        updateAgeCategoryDropdown();
        updateFilterSummary();
    };

    const updateFilterSummary = () => {
        let summaryParts = [];
        
        if (activeFilter === 'male') summaryParts.push('Men');
        else if (activeFilter === 'female') summaryParts.push('Women');
        else summaryParts.push('All Athletes');
        
        if (activeAgeCategory !== 'all') {
            summaryParts.push(activeAgeCategory);
        }
        
        filterSummaryText.textContent = summaryParts.join(' • ');
        
        if (activeFilter !== 'all' || activeAgeCategory !== 'all') {
            filterSummary.classList.remove('hidden');
        } else {
            filterSummary.classList.add('hidden');
        }
    };


    // ##########################################
    // ## MODIFICATION 1: Updated renderTable function ##
    // ##########################################
    const renderTable = () => {
        resultsBody.innerHTML = '';
        noResultsMessage.classList.toggle('hidden', displayedData.length > 0);

        let currentRank = 0;
        let lastTimeSeconds = -1;

        if (displayedData.length > 0) {
            displayedData.forEach((athlete, index) => {
                let rankToShow;

                if (athlete.time_seconds !== lastTimeSeconds) {
                    // This is a new time, so the rank is the current position (index + 1)
                    currentRank = index + 1;
                    lastTimeSeconds = athlete.time_seconds;
                    rankToShow = currentRank;
                } else {
                    // This is a tied time, so use the same rank as the previous athlete
                    rankToShow = currentRank;
                }
                
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="py-3 px-4 border-b font-bold">${rankToShow}</td>
                    <td class="py-3 px-4 border-b font-medium">${athlete.name}</td>
                    <td class="py-3 px-4 border-b font-semibold text-ahrc-purple">${athlete.fastest_time}</td>
                    <td class="py-3 px-4 border-b">${new Date(athlete.date_of_time).toLocaleDateString()}</td>
                    <td class="py-3 px-4 border-b">${athlete.location || ''}</td>
                    <td class="py-3 px-4 border-b">${athlete.gender}</td>
                    <td class="py-3 px-4 border-b">${athlete.age_category}</td>
                `;
                resultsBody.appendChild(row);
            });
        }
    };
    
    // ... Other functions (updateAgeCategoryDropdown, filter listeners, exportCsv, listenToYearData) (unchanged) ...
    const updateAgeCategoryDropdown = () => {
        const previousValue = ageCategorySelect.value;
        ageCategorySelect.innerHTML = '<option value="all">All Ages</option>';
        
        if (activeFilter === 'all') {
            ageCategorySelect.disabled = true;
            ageCategorySelect.classList.add('bg-gray-100', 'cursor-not-allowed');
            return;
        }
        
        ageCategorySelect.disabled = false;
        ageCategorySelect.classList.remove('bg-gray-100', 'cursor-not-allowed');
        
        const categories = [...new Set(allAthleteData
            .filter(a => a.gender.toLowerCase() === activeFilter)
            .map(a => a.age_category))].sort();
        
        categories.forEach(cat => {
            const option = document.createElement('option');
            option.value = cat;
            option.textContent = cat;
            ageCategorySelect.appendChild(option);
        });
        
        if (categories.includes(previousValue)) {
            ageCategorySelect.value = previousValue;
        } else {
            ageCategorySelect.value = 'all';
            activeAgeCategory = 'all';
        }
    };

    filterButtons.forEach(button => {
        button.addEventListener('click', () => {
            filterButtons.forEach(btn => { 
                btn.classList.replace('bg-ahrc-purple', 'bg-gray-200'); 
                btn.classList.replace('text-white', 'text-gray-700'); 
            });
            button.classList.replace('bg-gray-200', 'bg-ahrc-purple'); 
            button.classList.replace('text-gray-700', 'text-white');
            activeFilter = button.dataset.filter; 
            activeAgeCategory = 'all';
            ageCategorySelect.value = 'all';
            applyFilters();
        });
    });

    ageCategorySelect.addEventListener('change', () => {
        activeAgeCategory = ageCategorySelect.value;
        applyFilters();
    });

    resetFiltersBtn.addEventListener('click', () => {
        activeFilter = 'all';
        activeAgeCategory = 'all';
        ageCategorySelect.value = 'all';
        
        filterButtons.forEach(btn => { 
            btn.classList.replace('bg-ahrc-purple', 'bg-gray-200'); 
            btn.classList.replace('text-white', 'text-gray-700'); 
        });
        filterButtons[0].classList.replace('bg-gray-200', 'bg-ahrc-purple');
        filterButtons[0].classList.add('text-white');
        
        applyFilters();
    });
    
    exportCsvButton.addEventListener('click', () => {
        if (displayedData.length === 0) { showFeedback('No data to export.', 'info', 2000); return; }
        // Note: The CSV export will still show sequential ranks (index + 1),
        // because it doesn't re-use the ranking logic from renderTable.
        // This could be updated if needed.
        const headers = ['Rank', 'Athlete', 'Fastest Time', 'Date', 'Location', 'Gender', 'Age Category'];
        const csvRows = [headers.join(',')];
        displayedData.forEach((athlete, index) => {
            csvRows.push([
                index + 1, // This does not reflect the "tie" rank logic
                `"${athlete.name}"`,
                athlete.fastest_time,
                athlete.date_of_time,
                `"${athlete.location || ''}"`,
                athlete.gender,
                athlete.age_category
            ].join(','));
        });
        const blob = new Blob([csvRows.join('\n')], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `championship_results_${selectedYear.replace('-', '_')}.csv`;
        link.click();
        URL.revokeObjectURL(link.href);
    });

    function listenToYearData(yearString) {
        if (unsubscribe) unsubscribe();
        selectedYear = yearString;
        championshipHeader.textContent = `Standings for ${yearString.replace('-', '/')}`;
        loadingDiv.style.display = 'block';
        resultsContent.classList.add('hidden');
        allAthleteData = [];
        applyFilters();

        const athletesCollectionRef = collection(db, `championships/${yearString}/athletes`);
        unsubscribe = onSnapshot(athletesCollectionRef, (snapshot) => {
            allAthleteData = snapshot.docs.map(doc => doc.data());
            loadingDiv.style.display = 'none';
            resultsContent.classList.remove('hidden');
            applyFilters();
        }, (error) => {
            console.error(`Error for ${yearString}: `, error);
            loadingDiv.textContent = "Error loading data. Try another season.";
            noResultsMessage.classList.remove('hidden');
            noResultsMessage.textContent = `No data found for the ${yearString.replace('-', '/')} season.`;
        });
    }

    async function initialize() {
        try {
            await signInAnonymously(auth);

            submitButton.disabled = false;
            submitButton.textContent = 'Submit Time';

            const metadataRef = doc(db, "championships", "_metadata");
            onSnapshot(metadataRef, (docSnap) => {
                const currentSeason = getChampionshipYearString(new Date());
                let years = [];

                if (docSnap.exists()) {
                    years = docSnap.data().availableYears || [];
                }
                
                if (!years.includes(currentSeason)) {
                    years.push(currentSeason);
                }
                
                years.sort().reverse(); 

                const currentSelectedYearInDropdown = yearSelector.value;
                yearSelector.innerHTML = '';
                years.forEach(yearString => {
                    const option = document.createElement('option');
                    option.value = yearString;
                    option.textContent = yearString.replace('-', '/');
                    yearSelector.appendChild(option);
                });

                // #################################################
                // ## MODIFICATION 2: Default to currentSeason    ##
                // #################################################
                
                // Check if the dropdown already has a year selected AND it's not the first-time load (selectedYear)
                // If so, keep the user's selection.
                // Otherwise, default to the current season.
                let yearToLoad;
                if(selectedYear && years.includes(currentSelectedYearInDropdown)) {
                    yearToLoad = currentSelectedYearInDropdown;
                } else {
                    yearToLoad = currentSeason;
                }

                yearSelector.value = yearToLoad; // Explicitly set dropdown to the desired year
                
                if (selectedYear !== yearToLoad) {
                     listenToYearData(yearToLoad);
                }
            });
            
            yearSelector.addEventListener('change', () => listenToYearData(yearSelector.value));

        } catch(error) {
            console.error("Initialization failed:", error);
            loadingDiv.textContent = "Could not connect to the server. Please refresh.";
            submitButton.textContent = 'Connection Failed';
        }
    }

    initialize();
</script>

</body>
</html>
